# تکمیل فرآیند و بازگشت به دیوار (Completion)

:::danger به‌روزرسانی مهم و ساده‌سازی فرآیند
مکانیزم بازگشت کاربر به دیوار به طور کامل ساده‌سازی شده است. روش‌های قدیمی که در آن‌ها از `return_url` اختصاصی یا ارسال پارامترهایی مانند `status` و `message` در لینک بازگشت استفاده می‌شد، **به طور کامل منسوخ (Deprecated) شده‌اند.**

لطفاً از مکانیزم جدید که در ادامه توضیح داده شده است، استفاده کنید.
:::

یکی از اصول اساسی در طراحی افزونه‌های کنار، بازگرداندن کنترل به کاربر و پلتفرم دیوار پس از پایان تعامل است. فرقی نمی‌کند کاربر فرآیند را با موفقیت به اتمام برساند یا از آن انصراف دهد؛ **افزونه شما در هر حالتی موظف است کاربر را به دیوار بازگرداند.**

## مکانیزم جدید بازگشت: هدایت به یک لینک ثابت

در روش جدید، شما تنها یک وظیفه دارید: **کاربر را به آدرس ثابت زیر هدایت (Redirect) کنید.**

```
https://open-platform-redirect.divar.ir/completion
```

این آدرس هیچ‌گونه پارامتری نیاز ندارد. پلتفرم دیوار به صورت هوشمند جلسه (Session) کاربر را شناسایی کرده و او را دقیقاً به همان نقطه‌ای که از آن آمده بود (صفحه چت، مدیریت آگهی و...) باز می‌گرداند.

## نکات کلیدی و مسئولیت‌های شما

با توجه به این‌که در این مکانیزم جدید، هیچ اطلاعاتی درباره نتیجه عملیات (موفقیت، خطا یا انصراف) در لینک بازگشت ارسال نمی‌شود، مسئولیت‌های زیر بر عهده شماست:

### ۱. اطمینان از اتمام عملیات سمت سرور

قبل از اینکه کاربر را به لینک بازگشت هدایت کنید، باید مطمئن شوید که تمام عملیات لازم در سمت سرور شما (و هرگونه فراخوانی API به سرویس‌های کنار) به طور کامل انجام و نهایی شده است.

**مثال:** اگر افزونه شما یک برچسب «ارسال فوری» به آگهی اضافه می‌کند، باید:

1.  ابتدا API مربوط به افزودن برچسب را فراخوانی کنید.
2.  پس از دریافت پاسخ موفقیت‌آمیز از API،
3.  کاربر را به لینک `https://open-platform-redirect.divar.ir/completion` هدایت کنید.

### ۲. مدیریت وضعیت در رابط کاربری

از آنجایی که دیوار پس از بازگشت کاربر، پیامی مبنی بر موفقیت یا عدم موفقیت نمایش نمی‌دهد، بهتر است نتیجه عملیات را در لحظه و **در رابط کاربری خودتان** به کاربر اطلاع دهید.

**مثال:** پس از کلیک کاربر روی دکمه «تایید»، می‌توانید یک پیام «سرویس با موفقیت فعال شد» در همان صفحه به او نمایش دهید و سپس با یک تاخیر کوتاه (مثلاً ۲ ثانیه)، او را به صورت خودکار به دیوار بازگردانید.

### ۳. فراهم کردن راه‌های خروج واضح

همیشه در تمام مراحل فرآیند، دکمه‌های واضحی برای «انصراف» یا «بازگشت به دیوار» قرار دهید. کلیک بر روی این دکمه‌ها نیز باید کاربر را به همان لینک ثابت هدایت کند.

:::tip خلاصه
برای بازگرداندن کاربر به دیوار، کافیست او را به آدرس `https://open-platform-redirect.divar.ir/completion` هدایت کنید. تمام مسئولیت مدیریت وضعیت و ذخیره‌سازی داده‌ها قبل از این مرحله، بر عهده اپلیکیشن شماست.
:::
